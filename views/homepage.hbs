<script type="text/javascript" src="/script/jquery.min.js"></script>
<script type="text/javascript" src="/script/qrcode.js"></script>
<script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>


{{#if index}}
<div class="header">
    <h1> Haomiao Han </h1>
</div>
<div class="nav">
    <a href="/about">About</a>
    <a href="/portfolio">Portfolio</a>
    <a href="/contact">Contact</a>
</div>
{{else}}
<!--
<div class="navbar">
    <div class="title">
        <img src="/img/percent-logo.png" alt="percent-logo">
    </div>
</div>
-->
<div class="content">
    {{#if generate}}
    <div class='flex-container'>
        <div class='left'>
            <img src="/img/percent-logo.png" alt="percent-logo">
        </div>
        <div class='right'>
            <h2 class='text-center white-title'>New Transaction</h2>
            <div class='transaction-input'>
                <input id="transact-text" type="text" onkeyup="makeCode()" placeholder="Enter transaction amount"/>
                <p class='italics'>QR code will be automatically generated below.</p>
                <!-- <button onclick="makeCode()">Generate QR Code</button> -->
                <div id="qrcode" ></div>
            </div>
        </div>
    </div>
    
    <script type="text/javascript">
        const qrcode = new QRCode(document.getElementById("qrcode"), {
            width: 100,
            height: 100
        });

        function makeCode() {		
            const elText = document.querySelector("#transact-text");
            console.log(elText.value);

            const qrCodeVal = {
                merchantName: 'Roosevelt Island Deli',
                transactionAmt: parseFloat(elText.value)
            }
            
            if (!elText.value) {
                //alert("Input a text");
                elText.focus();
                return;
            }
            
            qrcode.makeCode(JSON.stringify(qrCodeVal));
        }

    </script>
    {{/if}}
    {{#if transactions}}
    <div class='flex-container'>
        <div class='left'>
            <img src="/img/percent-logo.png" alt="percent-logo">
        </div>
        <div class='right'>
            <h2 class='text-center white-title'>Recent Transactions</h2>
            <div class="transactions-display"></div>
        </div>
    </div>
    <script type="text/javascript">
        const url = '/api/transactions';
        const transactionsDiv = document.body.querySelector('.transactions-display');

        const request = async () => {
            const response = await fetch(url);
            const comments = await response.json();

            console.log(comments);

            for (const c of comments) {
                transactionsDiv.appendChild(createNewTransactionDisplay(c));
            }
        };
        
        function createNewTransactionDisplay(c) {
            //create a new div
            const newCommentDiv = document.createElement('div');

            //create a new span for username
            const usernameSpan = document.createElement('p');
            usernameSpan.innerHTML = 'Customer: ' + c.userName;
            usernameSpan.classList.add('bold-font');

            const merchantSpan = document.createElement('p');
            merchantSpan.innerHTML = 'Merchant: ' + c.merchantName;
            merchantSpan.classList.add('bold-font');

            //create a new p for content
            const totalAmt = document.createElement('p');
            totalAmt.innerHTML = 'Transaction Amount: $' + c.transactionAmt;
            totalAmt.classList.add('italics');

            const cashPaid = document.createElement('p');
            cashPaid.innerHTML = 'Amount Paid in Cash: $' + c.cashPaid.toFixed(2);
            cashPaid.classList.add('italics');

            const change = document.createElement('p');
            change.innerHTML = 'Change Deposited into Account Balance: $' + c.change.toFixed(2);
            change.classList.add('italics');

            //create a new p for date
            const datePara = document.createElement('p');
            const date = new Date(c.date);
            datePara.classList.add('italics-font');

            //combine everything
            newCommentDiv.appendChild(usernameSpan);
            newCommentDiv.appendChild(merchantSpan);
            newCommentDiv.appendChild(cashPaid);
            newCommentDiv.appendChild(totalAmt);
            newCommentDiv.appendChild(change);
            newCommentDiv.appendChild(datePara);
            newCommentDiv.appendChild(document.createElement('hr'));

            return newCommentDiv;
        }

        document.addEventListener('DOMContentLoaded', request());
    </script>
    {{/if}}

    {{#if scan}}
    <div class='flex-container'>
        <div class='left'>
            <img src="/img/percent-logo.png" alt="percent-logo">
        </div>
        <div class='right'>
            <h2 class='text-center white-title'>Scan QR Code Here:</h2>
            <div class='scan-result'>
                <p></p>
            </div>
            <div class='center-video'>
                <video id="preview"></video>
            </div>
        </div>
    </div>
    
    <script type="text/javascript">
        let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
            scanner.addListener('scan', function (content) {
            
            const url = '/api/transactions';
            const scanCodeResult = JSON.parse(content)
            const transactionObj = {
                merchantName: scanCodeResult.merchantName,
                userName: 'Bob', //hardcoded
                userID: 12345, //hardcoded
                transactionAmt: scanCodeResult.transactionAmt,
                cashPaid: Math.ceil(scanCodeResult.transactionAmt),
                change: Math.ceil(scanCodeResult.transactionAmt) - scanCodeResult.transactionAmt,
                date: new Date()
            };

            const alertStr = 'You spent $' + transactionObj.transactionAmt + ' at ' + transactionObj.merchantName;
            alert(alertStr);

            const request = async () => {
                try {
                    //try posting the comment
                    const response = await fetch(url, {
                        method: 'POST',
                        body: JSON.stringify(transactionObj),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const json = await response.json();

                    //if we got back something, display a success alert and show the new comment
                    if (json) {
                        console.log(json);
                    }
                }
                catch(e) {
                    //if we got an error, display an error alert
                    console.log(e);
                }
            };

            request();
        });

        Instascan.Camera.getCameras().then(function (cameras) {
            if (cameras.length > 0) {
                scanner.start(cameras[0]);
            } 
            else {
                console.error('No cameras found.');
            }
        }).catch(function (e) {
            console.error(e);
        });

    </script>
    
    {{/if}}

</div>
{{/if}}
